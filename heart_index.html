<!DOCTYPE html>
<html lang="en" style="height:100%">
	<head>
		<title>Silo6_heart</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Helvetica;
				font-size: 100%;
				background-color: #000;
				color: #fff;
				margin: 0px;
				overflow: hidden;
			}
		</style>
		<link rel="stylesheet" href="styles/new_style.css">
		<script src="js/three.min.js"></script>
		<script src="js/zinc_threejs_control.js"></script>
		<script src="js/zinc_3js_renderer.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/dojo.js" data-dojo-config="async: 1, parseOnLoad: true" ></script>
		<script src="../../dojo-release-1.11.2/dojo/dojo.js" data-dojo-config="async: 1, parseOnLoad: true" ></script>
		<script>
			var dojoConfig = {
		        async: true,
		        // This code registers the correct location of the "demo" package
		        // so we can load Dojo from the CDN whilst still being able to
		        // load local modules
		        packages: [{
		            name: "js",
		            location: location.pathname.replace(/\/[^/]+$/, '')  + '/js'
		        }]
			};
		</script>
	</head>
	<body style='height:100%;font-family="Helvetica"'>
	<div id="main_page" class="heartpage">
		<div id="footMore" class="open">
			<div style="position:absolute;left:5%">
				<img src="images/new_image/click2.png" alt="more" style="float:left;width:60%">
			</div>
			<div style="position:absolute;right:5%">
				<img src="images/new_image/spin2.png" alt="more" style="float:right;width:60%">
			</div>
		</div>
		
		<div id="rightInformation" class="open">
			<div class="rightChartTitle" style = "width:75%;float:right;padding:10px;color:orange;">
				<b>ECG</b>
			</div>
			<div id="rightECG" class="rightChart" style="width:75%;float:right;padding:10px;">
			</div>
			<div id="ECGDescription" class="rightChartDescription" style="width:75%;clear:right;float:right;padding:10px;color:orange;">
				electrical waves make the heart muscle contract
			</div>
			<div class="rightChartTitle" style="top:6%;width:75%;float:right;padding:10px;color:lime">
				<b>Pressure</b>
			</div>
			<div id="rightLVP" class="rightChart"  style="top:6%;float:right">
			</div>
			<div id="LVPDescription" class="rightChartDescription" style="top:6%;clear:right;width:75%;float:right;padding:10px;color:lime;">
				muscle contraction generates pump pressure
			</div>
			<div class="rightChartTitle" style = "top:10%;width:75%;float:right;padding:10px;clear:right">
				<b>Heart Rate</b>
			</div>
			<div id="rightRate" style = "top:10%;width:75%;clear:right;float:right;padding:10px">
				<input id="speed_slider" type="range" min="0" max="5000" value ="1000" step="1" oninput="updateSlider(this.value)" style="width:80%;"/>
			</div>
			<div class="rightChartDescription" style="top:10%;width:75%;clear:right;float:right;padding:10px">
				speed control
			</div>
			<div id="rightLogo" class="rightLogo">
				<img src="images/heart_v7/medtechCORE.png"  height="75px">
			</div>
			
		</div>
		
		<div id="bottom_control" class="closed">
			<div id="home_icon" class="closed" style="left:0%;bottom:0%;position:absolute;z-index:10;height:75%;">
				<img src="images/new_image/home.png" alt="home"  onclick="homeClicked()" style="max-height:100%;">
			</div>
			<div id="home_selected_icon" class="open" style="left:0%;bottom:0%;position:absolute;z-index:10;height:75%;">
				<img src="images/new_image/home_selected.png" alt="home"  onclick="homeClicked()" style="max-height:100%;">
			</div>
			<div id="halfHeart" class="halfHeart closed" style="right:2%;bottom:0%;position:absolute;z-index:10;height:75%;">
				<img src="images/new_image/half_heart.png" alt="halfHeart" style="max-height:100%;" onclick="halfHeartPressed()">
			</div>
			<div id="fibrillation_icon" class="bottomButton open" style="left:10%;bottom:0%;position:absolute;z-index:10;height:75%;">
				<img src="images/heart_v7/fibrillation_icon.png" alt="information" style="max-height:100%;" onclick="heartElectricityClicked()">
			</div>
			<div id="attack_icon" lass="bottomButton open" style="left:20%;bottom:0%;position:absolute;z-index:10;height:75%;">
				<img src="images/heart_v7/attack_icon.png" alt="information" style="max-height:100%;" onclick="heartAttackClicked()">
			</div>
			<div id="failure_icon" class="bottomButton open" style="left:30%;bottom:0%;position:absolute;z-index:10;height:75%;">
				<img src="images/heart_v7/failure_icon.png" alt="information" style="max-height:100%;" onclick="heartFailureClicked()">
			</div>
			<div id="fibrillation_selected_icon" class="bottomButton closed" style="left:10%;bottom:0%;position:absolute;z-index:10;height:75%;">
				<img src="images/heart_v7/fibrillation_selected_icon.png" alt="information" style="max-height:100%;">
			</div>
			<div id="attack_selected_icon" class="bottomButton closed" style="left:20%;bottom:0%;position:absolute;z-index:10;height:75%;">
				<img src="images/heart_v7/attack_selected_icon.png" alt="information" style="max-height:100%;">
			</div>
			<div id="failure_selected_icon" class="bottomButton closed" style="left:30%;bottom:0%;position:absolute;z-index:10;height:75%;">
				<img src="images/heart_v7/failure_selected_icon.png" alt="information" style="max-height:100%;">
			</div>
			<div id="fullHeart" class="halfHeart closed" style="right:2%;bottom:0%;position:absolute;z-index:10;height:75%;"">
				<img src="images/new_image/full_heart.png" alt="fullHeart"  style="max-height:100%;"onclick="halfHeartPressed()">
			</div>
		</div>
		
		<div id="initialNormal" class="closed leftPanel">
			<div class="leftTitle" style="color:#00ccff" >
				<b>The Heart</b>
			</div>
			<div class="leftDescription" style="color:#00ccff">
				<b>Muscles pumping blood</b>
			</div>
			<div class="leftDetail" style="color:rgb(175, 175, 175);">
				<p>The main job of the heart is to pump blood around the body to meet the demands of the organ systems.</p>
				<p>The main pumping chambers of the heart are the left and right ventricles.</p>
				<p>Contraction of the thick muscular walls of the ventricles generates the pressure needed to pump blood around the body.</p>
				<p>Select below to learn about some common heart problems. </p>
			</div>
			
		</div>
		
		<div id="leftHeartElectricity" class="closed leftPanel">
			<div class="leftTitle" style="color:rgb(255,192,0);" >
				<b>Heart Electricity</b>
			</div>
			<div class="leftDescription" style="color:rgb(255,192,0);">
				<b>Coordinated contraction</b>
			</div>
			<div class="leftDetail" style="color:rgb(175, 175, 175);">
				In a healthy heart, electrical waves pass smoothly through the muscle to provide coordinated contraction and efficient pumping.
			</div>
			<div class="leftClickable" onclick="arrhythmiaClicked()">
				<b>What happens when the smooth electrical waves are disrupted?</b>
			</div>
			<div class="leftProgressBar">
				<div style="max-width:100%;background-color: transparent;">
					<div class="progressClickable" style="left:0%;width:33%;background-color: transparent;">
					</div>
					<div class="progressClickable" style="left:45%;width:33%;background-color: transparent;" onclick="arrhythmiaClicked()">
					</div>
				</div>
				<img src="images/heart_v7/health_electricity.png" alt="information" height="50px">
			</div>
		</div>
		
		<div id="leftHeartArrhythmia" class="closed leftPanel">
			<div class="leftTitle" style="color:rgb(255,192,0);" >
				<b>Fibrillation</b>
			</div>
			<div class="leftDescription" style="color:rgb(255,192,0);">
				<b>Chaotic contraction</b>
			</div>
			<div class="leftDetail" style="color:rgb(175, 175, 175);">
				<p>Electrical disruption leads to fibrillation and chaotic contraction. This means the heart cannot generate enough pressure to pump the blood.</p>
				<p>To fix a fibrillating heart, we need to apply a large electrical shock to reset the electrical waves. We need an Automated External Defibrillator (AED).</p>
			</div>
			<div class="leftClickableAED" onclick="AEDClicked()">
				<b><br>Defibrillate</b>
			</div>
			<div class="leftProgressBar">
				<div style="max-width:100%;background-color: transparent;">
					<div class="progressClickable" style="left:0%;width:33%;height:50px;background-color: transparent;" onclick="heartElectricityClicked()">
					</div>
					<div class="progressClickable" style="left:45%;width:33%;height:50px;background-color: transparent;">
					</div>
				</div>
				<img src="images/heart_v7/fibrillation_electricity.png" alt="information" height="50px">
			</div>
		</div>
	
		<div id="leftHeartAttack" class="closed leftPanel">
			<div class="leftTitle" style="color:rgb(106,236,8);" >
				<b>Healthy Heart</b>
			</div>
			<div class="leftDescription" style="color:rgb(106,236,8);">
				<b>Healthy muscle</b>
			</div>
			<div id="NormalHeartAttackDetail" class="leftDetail" style="color:rgb(175, 175, 175);">
				The heart muscle needs blood to survive. The healthy heart pumps blood to nourish itself through its coronary arteries.
			</div>
			
			<div class="leftClickable"  onclick="heartAttackStagePressed('SmallInfarct', 'MildHeartAttack', 'leftModerateAttack')">
				<b>What happens during a heart attack?</b>
			</div>
			<div class="leftProgressBar">
				<div style="max-width:100%;background-color: transparent;">
					<div class="progressClickable" style="left:0%;height:40%;width:33%;background-color: transparent;">
					</div>
					<div class="progressClickable" style="left:33%;height:40%;width:33%;background-color: transparent;"  onclick="heartAttackStagePressed('SmallInfarct', 'MildHeartAttack', 'leftModerateAttack')">
					</div>
					<div class="progressClickable" style="left:66%;height:40%;width:33%;background-color: transparent;"  onclick="heartAttackStagePressed('LargeInfarct', 'SevereHeartAttack', 'leftSevereAttack')">
					</div>
				</div>
				<img src="images/heart_v7/health_attack.png" alt="information" height="50px">
			</div>		
		</div>
		
		
		<div id="leftModerateAttack" class="closed leftPanel">
			<div class="leftTitle" style="color:rgb(106,236,8);" >
				<b>Heart Attack</b>
			</div>
			<div class="leftDescription" style="color:rgb(106,236,8);">
				<b>Damaged muscle</b>
			</div>
			<div id="NormalHeartAttackDetail" class="leftDetail" style="color:rgb(175, 175, 175);">
				<p>In a heart attack, blocked arteries lead to muscle damage, which reduces the heartâ€™s ability to pump blood. </p>
			</div>
			<div class="leftLargeClickable">
				<img src="images/heart_v7/coronary_block_moderate.png" alt="information" style="float:center" height="300px">
			</div>
			<div id="NormalHeartAttackDetail" class="leftDetail" style="color:rgb(175, 175, 175);">
				<p>Medication can help to unblock the arteries.</p>
			</div>
			<div class="leftClickable"  onclick="heartAttackStagePressed('LargeInfarct', 'SevereHeartAttack', 'leftSevereAttack')" >
				<b>What happens if you don't take your medication?</b>
			</div>
			<div class="leftProgressBar">
				<div style="max-width:100%;background-color: transparent;">
					<div class="progressClickable" style="left:0%;height:40%;width:33%;background-color: transparent;" onclick="heartAttackStagePressed('NoInfarct', 'NoHeartAttack', 'leftHeartAttack')">
					</div>
					<div class="progressClickable" style="left:33%;height:40%;width:33%;background-color: transparent;">
					</div>
					<div class="progressClickable" style="left:66%;height:40%;width:33%;background-color: transparent;"  onclick="heartAttackStagePressed('LargeInfarct', 'SevereHeartAttack', 'leftSevereAttack')">
					</div>
				</div>
				<img src="images/heart_v7/moderate_attack.png" alt="information" height="50px">
			</div>
		</div>
		
		<div id="leftSevereAttack" class="closed leftPanel">
			<div class="leftTitle" style="color:rgb(106,236,8);" >
				<b>Heart Attack</b>
			</div>
			<div class="leftDescription" style="color:rgb(106,236,8);">
				<b>Severe muscle damage</b>
			</div>
			<div id="NormalHeartAttackDetail" class="leftDetail" style="color:rgb(175, 175, 175);">
				<p>If blocked arteries are left untreated, more of the muscle gets damaged, and the pumping ability of the heart is severely reduced. </p>
			</div>
			<div class="leftLargeClickable">
				<img src="images/heart_v7/coronary_block_severe.png" alt="information" style="float:center" height="300px">
			</div>
			<div id="NormalHeartAttackDetail" class="leftDetail" style="color:rgb(175, 175, 175);">
				<p>Medication can help to unblock the arteries.</p>
			</div>
			<div class="leftProgressBar">
				<div style="max-width:100%;background-color: transparent;">
					<div class="progressClickable" style="left:0%;height:40%;width:33%;background-color: transparent;" onclick="heartAttackStagePressed('NoInfarct', 'NoHeartAttack', 'leftHeartAttack')">
					</div>
					<div class="progressClickable" style="left:33%;height:40%;width:33%;background-color: transparent;" onclick="heartAttackStagePressed('SmallInfarct', 'MildHeartAttack', 'leftModerateAttack')">
					</div>
					<div class="progressClickable" style="left:66%;height:40%;width:33%;background-color: transparent;">
					</div>
				</div>
				<img src="images/heart_v7/severe_attack.png" alt="information" height="50px">
			</div>
		</div>

		<div id="leftHeartFailure" class="closed leftPanel">
			<div class="leftTitle" style="color:rgb(255,0,128);" >
				<b>Heart Failure</b>
			</div>
			<div class="leftDescription" style="color:rgb(255,0,128);">
				<b>Healthy heart</b>
			</div>
			<div id="NormalHeartFailureDetail" class="leftDetail" style="color:rgb(175, 175, 175);">
				<p>The shape, stiffness and contraction force in the healthy heart maximises pumping performance. </p>
				<p>Heart failure involves long term changes in heart properties due to factors such as high blood pressure.</p>
			</div>
			<div class="leftClickable" onclick="heartFailureStagePressed('CompensatedFailure', 'CompensatedFailure', 'leftCompensatedFailure')" >
				<b>What can long term high blood pressure do to the heart?</b>
			</div>
			<div class="leftProgressBar">
				<div style="max-width:100%;background-color: transparent;">
					<div class="progressClickable" style="left:0%;height:40%;width:33%;background-color: transparent;">
					</div>
					<div class="progressClickable" style="left:33%;height:40%;width:33%;background-color: transparent;"  onclick="heartFailureStagePressed('CompensatedFailure', 'CompensatedFailure', 'leftCompensatedFailure')">
					</div>
					<div class="progressClickable" style="left:66%;height:40%;width:33%;background-color: transparent;"  onclick="heartFailureStagePressed('DecompensatedFailure', 'DecompensatedFailure', 'leftDecompensatedFailure')">
					</div>
				</div>
				<img src="images/heart_v7/heart_failure.png" alt="information" height="50px">
			</div>
		</div>
		
		<div id="leftCompensatedFailure" class="closed leftPanel">
			<div class="leftTitle" style="color:rgb(255,0,128);" >
				<b>Heart Failure</b>
			</div>
			<div class="leftDescription" style="color:rgb(255,0,128);">
				<b>Coping with extra load</b>
			</div>
			<div id="NormalHeartFailureDetail" class="leftDetail" style="color:rgb(175, 175, 175);">
				<p>High blood pressure means the heart needs to work harder to compensate and maintain its pumping performance.</p>
				<p>This extra effort can make the heart muscle walls get thicker.</p>
			</div>
			<div class="leftClickable"  onclick="heartFailureStagePressed('DecompensatedFailure', 'DecompensatedFailure', 'leftDecompensatedFailure')">
				<b>What happens if high blood pressure is left untreated?</b>
			</div>
			<div class="leftProgressBar">
				<div style="max-width:100%;background-color: transparent;">
					<div class="progressClickable" style="left:0%;height:40%;width:33%;background-color: transparent;" onclick="heartFailureStagePressed('NoFailure', 'NoFailure', 'leftHeartFailure')">
					</div>
					<div class="progressClickable" style="left:33%;height:40%;width:33%;background-color: transparent;">
					</div>
					<div class="progressClickable" style="left:66%;height:40%;width:33%;background-color: transparent;"  onclick="heartFailureStagePressed('DecompensatedFailure', 'DecompensatedFailure', 'leftDecompensatedFailure')">
					</div>
				</div>
				<img src="images/heart_v7/compensated_failure.png" alt="information" height="50px">
			</div>
		</div>

		<div id="leftDecompensatedFailure" class="closed leftPanel">
			<div class="leftTitle" style="color:rgb(255,0,128);" >
				<b>Heart Failure</b>
			</div>
			<div class="leftDescription" style="color:rgb(255,0,128);">
				<b>Over-loaded heart</b>
			</div>
			<div id="NormalHeartFailureDetail" class="leftDetail" style="color:rgb(175, 175, 175);">
				<p>Following long-term high blood pressure, the heart loses its ability to compensate and effectively pump. This results in a larger heart with thinner muscular walls.</p>
			</div>
			<div class="leftProgressBar">
				<div style="max-width:100%;background-color: transparent;">
					<div class="progressClickable" style="left:0%;height:40%;width:33%;background-color: transparent;" onclick="heartFailureStagePressed('NoFailure', 'NoFailure', 'leftHeartFailure')">
					</div>
					<div class="progressClickable" style="left:33%;height:40%;width:33%;background-color: transparent;" onclick="heartFailureStagePressed('CompensatedFailure', 'CompensatedFailure', 'leftCompensatedFailure')">
					</div>
					<div class="progressClickable" style="left:66%;height:40%;width:33%;background-color: transparent;">
					</div>
				</div>
				<img src="images/heart_v7/decompensated_failure.png" alt="information" height="50px">
			</div>
		</div>
	
		<div id="more" class="closed" onclick="moreClicked()">
			<img src="images/more.png" alt="more" style="height:40%;">
		</div>

		
		<div id="myRenderer" class="open">
		</div>

	</div>
	
	<script>
		var ECGchart = undefined;
		var LVPchart = undefined;
		var ECGurls = [];
		var LVPurls = [];
		var ECGs = [];
		var LVPs = [];
		var ECGTexts = [];
		var LVPTexts = [];
		var modelURLsArray = [];
		var currentECGName = 'None';
		var currentLVPName = 'None';
		var ecgIndicator = undefined;
		var lvpIndicator = undefined;
		var maxECGTime = 0.0, maxLVPTime = 0.0;
		var minECGTime = 0.0, minLVPTime = 0.0
		var timeLineOffset = 0.0;
		setUpArrays();
		var container = document.getElementById('myRenderer')
		var zincRenderer = new Zinc.Renderer(container, window);
		Zinc.defaultMaterialColor = 0xFFFF9C;
		zincRenderer.initialiseVisualisation();
		zincRenderer.getThreeJSRenderer().setClearColor( 0xffffff, 0);
		var halfHeartFlag = false;
		var leftPanelIDs = ["initialNormal", "leftHeartElectricity", "leftHeartArrhythmia", "leftHeartAttack",
			"leftModerateAttack", "leftSevereAttack", "leftHeartFailure", "leftCompensatedFailure", "leftDecompensatedFailure"];
		var idleTime = 0;
		var idleTimeLimit = 120000;
		var oldTime = new Date();
		var iconIds = ["fibrillation_icon", "attack_icon", "failure_icon", "fibrillation_selected_icon",
			"attack_selected_icon", "failure_selected_icon"];
		var modelToSceneArray = [];
		var previousCamera = undefined;

		function displayHalfHeartIcon() {
			if (halfHeartFlag) {
				document.getElementById('halfHeart').classList.remove('open');
				document.getElementById('halfHeart').classList.add('closed');
				document.getElementById('fullHeart').classList.remove('closed');
				document.getElementById('fullHeart').classList.add('open');
			} else {
				document.getElementById('halfHeart').classList.remove('closed');
				document.getElementById('halfHeart').classList.add('open');
				document.getElementById('fullHeart').classList.remove('open');
				document.getElementById('fullHeart').classList.add('closed');
			}
		}
		
		function idleTimerReached() {
			if (document.getElementById('footMore').classList.contains('closed')) {
				leftPanelTrigger(undefined);
				document.getElementById('rightInformation').className = 'closed';
				document.getElementById('footMore').className = 'open';
				document.getElementById('bottom_control').className = 'closed';
				document.getElementById('halfHeart').classList.remove('open');
				document.getElementById('halfHeart').classList.add('closed');
				document.getElementById('fullHeart').classList.remove('open');
				document.getElementById('fullHeart').classList.add('closed');
				resetAllModelsView();
				halfHeartFlag = false;
				loadModel("DeformingHeart", 1.0);
			}
		}
		
		function homeClicked() {
			if (document.getElementById('initialNormal').classList.contains('closed')) {
				showIcons("fibrillation_icon", "attack_icon", "failure_icon");
				leftPanelTrigger("initialNormal");
				document.getElementById('footMore').className = 'closed';
				previousCamera = undefined;
				resetAllModelsView();
				halfHeartFlag = false;
				document.getElementById('halfHeart').classList.remove('closed');
				document.getElementById('halfHeart').classList.add('open');
				document.getElementById('fullHeart').classList.remove('open');
				document.getElementById('fullHeart').classList.add('closed');				
				loadModel("DeformingHeart", 1.0);
				document.getElementById("home_icon").className = 'closed';
				document.getElementById("home_selected_icon").className = 'open';
			}
		}
		
		function leftPanelTrigger(elementIdToDisplay) {
			for(var i = 0; i < leftPanelIDs.length; i++){
    			var id = leftPanelIDs[i];
				document.getElementById(id).classList.remove('open');
				document.getElementById(id).classList.add('closed');
			}
			if (elementIdToDisplay) {
				document.getElementById(elementIdToDisplay).classList.remove('closed');
				document.getElementById(elementIdToDisplay).classList.add('open');
			}
		}
		
		var pageClicked = function() {
			if (document.getElementById('footMore').className == 'open'){
				showIcons("fibrillation_icon", "attack_icon", "failure_icon");
				leftPanelTrigger('initialNormal');
				document.getElementById('footMore').className = 'closed';
				document.getElementById('rightInformation').className = 'open';
				document.getElementById('bottom_control').className = 'open';
				document.getElementById('halfHeart').classList.remove('closed');
				document.getElementById('halfHeart').classList.add('open');
				document.getElementById('fullHeart').classList.remove('open');
				document.getElementById('fullHeart').classList.add('closed');	
				document.getElementById("home_icon").className = 'closed';
				document.getElementById("home_selected_icon").className = 'open';
				showECGAndLVP("Normal", -0.075);
			}
		}
		
		function showIcons(showIcon1, showIcon2, showIcon3) {
			for(var i = 0; i < iconIds.length; i++){
	    			var id = iconIds[i];
	    			if ((id != showIcon1) && (id != showIcon2) && (id != showIcon3)) {
					document.getElementById(id).classList.remove('open');
					document.getElementById(id).classList.add('closed');
				}
			}
			if (document.getElementById(showIcon1).classList.contains('closed')) {
				document.getElementById(showIcon1).classList.remove('closed');
				document.getElementById(showIcon1).classList.add('open');
			}
			if (document.getElementById(showIcon2).classList.contains('closed')) {
				document.getElementById(showIcon2).classList.remove('closed');
				document.getElementById(showIcon2).classList.add('open');
			}
			if (document.getElementById(showIcon3).classList.contains('closed')) {
				document.getElementById(showIcon3).classList.remove('closed');
				document.getElementById(showIcon3).classList.add('open');
			}

		}
		
		function heartElectricityClicked() {
			leftPanelTrigger('leftHeartElectricity');
			showIcons("fibrillation_selected_icon", "attack_icon", "failure_icon");
			document.getElementById("home_icon").className = 'open';
			document.getElementById("home_selected_icon").className = 'closed';
			previousCamera = undefined;
			loadModel('NormalElectricity', 1.0);
			showECGAndLVP('Normal', 0.0);
		}
		
		function arrhythmiaClicked() {
			leftPanelTrigger('leftHeartArrhythmia');
			loadModel('ArrythmiaElectricity', 0.25);
			showECGAndLVP('Arrhythmia', 0.0);
		}
		
		function AEDClicked() {
			leftPanelTrigger('leftHeartElectricity');
			loadModel('NormalElectricity', 1.0);
			showECGAndLVP('Normal', 0.0);
		}
		
		function shareCameraSettings(oldCam) {
			if (oldCam) {
				var newCam = zincRenderer.getCurrentScene().camera;
				newCam.near = oldCam.near;
				newCam.far = oldCam.far;
				newCam.position.copy(oldCam.position);
				newCam.target = new THREE.Vector3( oldCam.target.x, oldCam.target.y, oldCam.target.z );
				newCam.up.copy(oldCam.up);
				zincRenderer.getCurrentScene().updateDirectionalLight();
			}
		}
		
		var heartAttackStagePressed = function(StageName, pressedElement, descriptionId) {
			loadModel(StageName, 1.0);
			previousCamera = zincRenderer.getCurrentScene().camera;
			showECGAndLVP(StageName, 0.0);
			document.getElementById('leftHeartAttack').classList.remove('open');
			document.getElementById('leftHeartAttack').classList.add('closed');
			document.getElementById('leftModerateAttack').classList.remove('open');
			document.getElementById('leftModerateAttack').classList.add('closed');
			document.getElementById('leftSevereAttack').classList.remove('open');
			document.getElementById('leftSevereAttack').classList.add('closed');
			document.getElementById(descriptionId).classList.remove('closed');
			document.getElementById(descriptionId).classList.add('open');
		}
		
		function heartAttackClicked() {
			showIcons("fibrillation_icon", "attack_selected_icon", "failure_icon");
			document.getElementById("home_icon").className = 'open';
			document.getElementById("home_selected_icon").className = 'closed';
			leftPanelTrigger('leftHeartAttack');
			previousCamera = undefined;
			heartAttackStagePressed('NoInfarct','NoHeartAttack', 'leftHeartAttack');
		}
		
		var dragFlag = 0;
		container.addEventListener("mousedown", function() {flag = 0; idleTime = 0;oldTime = new Date(); }, false);
		container.addEventListener("mousemove", function() {flag = 1; idleTime = 0;oldTime = new Date();}, false);
		container.addEventListener("mouseup", function(){idleTime = 0;oldTime = new Date();
		    if(flag === 0){pageClicked();}}, false);
		container.addEventListener("touchstart", function() {idleTime = 0;oldTime = new Date(); }, false);
		container.addEventListener("touchend", function() {idleTime = 0;oldTime = new Date();}, false);
		container.addEventListener("touchcancel", function(){idleTime = 0;oldTime = new Date();}, false);
		container.addEventListener("touchmove", function(){idleTime = 0;oldTime = new Date();}, false);
		
		loadModel("DeformingHeart", 1.0);
		zincRenderer.animate();
		document.getElementById("speed_slider").value = 1000;
		
		var updateIndicatorsAndTimer = function() {
			var newTime = new Date();
			idleTime = idleTime + newTime.getTime() - oldTime.getTime();
			oldTime = newTime;
			if (idleTime > idleTimeLimit) {
				idleTimerReached();
			}
		
			var normaliseTime = zincRenderer.getCurrentTime() / 3000.0;
			if (lvpIndicator && (currentLVPName != ' None') &&
				ecgIndicator && (currentECGName != ' None') &&
				document.getElementById('rightInformation').className == "open") {
				var lvpTime = normaliseTime * (maxLVPTime - minLVPTime) + minLVPTime;
				var ecgTime = normaliseTime * (maxECGTime - minECGTime) + minECGTime;
				if (timeLineOffset != 0.0) {
        			lvpTime = lvpTime + timeLineOffset;
        			ecgTime = ecgTime + timeLineOffset;
        			if (lvpTime > maxLVPTime) {
        				lvpTime = lvpTime - maxLVPTime + minLVPTime;
        			} else if ( lvpTime < minLVPTime) {
        				lvpTime = maxLVPTime - (minLVPTime - lvpTime);
        			}
        			if (ecgTime > maxECGTime) {
        				ecgTime = ecgTime - maxECGTime + minECGTime;
        			} else if ( ecgTime < minECGTime) {
        				ecgTime = maxECGTime - (minECGTime - ecgTime);
        			}
        		}
        		lvpIndicator.opt.values = [lvpTime];
        		ecgIndicator.opt.values = [ecgTime];
        		lvpIndicator.dirty = true;
        		lvpIndicator.render();
        		ecgIndicator.dirty = true;
        		ecgIndicator.render();
			}
		}
		
		zincRenderer.addPreRenderCallbackFunction(updateIndicatorsAndTimer);
		
		function geometryShowHalf() {
			return function(zincGeometry) {
				if (zincGeometry.groupName && zincGeometry.groupName.includes("Post")) {
					zincGeometry.setVisibility(!halfHeartFlag);
				}
			}
		}
		
		function showHalf() {
			var currentScene = zincRenderer.getCurrentScene();
			currentScene.forEachGeometry(geometryShowHalf());
		}
		
		function geometryIsShowingHalf() {
			return function(zincGeometry) {
				if (zincGeometry.groupName && zincGeometry.groupName.includes("Post")) {
					halfHeartFlag = zincGeometry.morph.visible ? false : true;
				}
			}
		}
		
		function isShowingHalf() {
			var currentScene = zincRenderer.getCurrentScene();
			currentScene.forEachGeometry(geometryIsShowingHalf());
		}
		
		var halfHeartPressed = function() {
			if (halfHeartFlag) {
				halfHeartFlag = false;
			} else {
				halfHeartFlag = true;
			}
			displayHalfHeartIcon();
			
			showHalf();
		}
	
		function setUpArrays() {
			ECGurls['Normal'] = 'ECG/NormalECG.json';
			ECGurls['Diastolic'] = 'ECG/DiastolicECG.json';
			ECGurls['Systolic'] = 'ECG/SystolicECG.json';
			LVPurls['Normal'] = 'LVP/NormalLVP.json';
			LVPurls['Diastolic'] = 'LVP/DiastolicLVP.json';
			LVPurls['Systolic'] = 'LVP/SystolicLVP.json';
			ECGurls['NoInfarct'] = 'ECG/NormalECG.json';
			ECGurls['SmallInfarct'] = 'ECG/MildInfarctECG.json';
			ECGurls['LargeInfarct'] = 'ECG/LargeInfarctECG.json';
			LVPurls['NoInfarct'] = 'LVP/NormalLVP.json';
			LVPurls['SmallInfarct'] = 'LVP/smallInfarctLVP.json';
			LVPurls['LargeInfarct'] = 'LVP/largeInfarctLVP.json';
			ECGurls['Arrhythmia'] = 'ECG/ArrhythmiaECG.json';
			LVPurls['Arrhythmia'] = 'LVP/ArrhythmiaLVP.json';
			ECGurls['NoFailure'] = 'ECG/NormalECG.json';
			LVPurls['NoFailure'] = 'LVP/NormalLVP.json';
			ECGurls['CompensatedFailure'] = 'ECG/DiastolicECG.json';
			LVPurls['CompensatedFailure'] = 'LVP/DiastolicLVP.json';
			ECGurls['DecompensatedFailure'] = 'ECG/SystolicECG.json';
			LVPurls['DecompensatedFailure'] = 'LVP/SystolicLVP.json';
			
			modelURLsArray['DeformingHeart'] = ['models/deforming_heart_metadata.json',
				'models/deforming_heart_view.json'];
			modelURLsArray['NormalElectricity'] = ['heartElectricity/normalActivity_metadata.json',
				'heartElectricity/normalActivity_view.json'];
			modelURLsArray['ArrythmiaElectricity'] = ['heartElectricity/arrythmiaActivity_metadata.json',
				'heartElectricity/arrythmiaActivity_view.json'];
			modelURLsArray['LargeInfarct'] = ['heartInfarct/largeInfarct_metadata.json',
				'heartInfarct/largeInfarct_view.json'];
			modelURLsArray['SmallInfarct'] = ['heartInfarct/smallInfarct_metadata.json',
				'heartInfarct/smallInfarct_view.json'];
			modelURLsArray['NoInfarct'] = ['heartInfarct/noInfarct_metadata.json',
				'heartInfarct/noInfarct_view.json'];
			modelURLsArray['NoFailure'] = ['heartInfarct/noInfarct_metadata.json',
				'heartInfarct/noInfarct_view.json'];
			modelURLsArray['CompensatedFailure'] = ['heartFailure/compensated_metadata.json', 'heartFailure/compensated_view.json'];
			modelURLsArray['DecompensatedFailure'] = ['heartFailure/decompensated_metadata.json', 'heartFailure/decompensated_view.json'];
				
			ECGTexts['Normal'] = "electrical pulses make the heart muscle contract";
			LVPTexts['Normal'] = "muscle contraction generates pump pressure";
			ECGTexts['Arrhythmia'] = "abnormal electricity";
			LVPTexts['Arrhythmia'] = "poor pump pressure";
			ECGTexts['NoInfarct'] = "electrical pulses make the heart muscle contract";
			LVPTexts['NoInfarct'] = "muscle contraction generates pump pressure";
			ECGTexts['SmallInfarct'] = "electrical pulses make the heart muscle contract";
			LVPTexts['SmallInfarct'] = "damaged muscle leads to less contraction force and less pressure generated";
			ECGTexts['LargeInfarct'] = "electrical pulses make the heart muscle contract";
			LVPTexts['LargeInfarct'] = "damaged muscle leads to less contraction force and less pressure generated";
			ECGTexts['NoFailure'] = "electrical pulses make the heart muscle contract";
			LVPTexts['NoFailure'] = "muscle contraction generates pump pressure";
			ECGTexts['CompensatedFailure'] = "electrical pulses make the heart muscle contract";
			LVPTexts['CompensatedFailure'] = "muscle contraction generates pump pressure";
			ECGTexts['DecompensatedFailure'] = "electrical pulses make the heart muscle contract";
			LVPTexts['DecompensatedFailure'] = "thin-walled hearts struggle to maintain pump pressure";
		}
		
		
		require(["dojo/ready"], function(ready){
			ready(function(){
				require([ "dojo/_base/declare", "dojo/dom-construct","dojox/charting/Chart", "dojox/charting/plot2d/StackedLines", "dojox/charting/plot2d/Grid", "dojox/charting/themes/Claro", "dojox/charting/axis2d/Default", "dojox/charting/plot2d/Indicator",
				"dojox/charting/themes/Tom"], 
					function(declare, domConstruct, Chart, StackedLines, Grid, Claro, axis2dDefault, plot2dIndicator, tomTheme){
						ready(function(){
								tomTheme.chart.fill="transparent";
								tomTheme.plotarea.fill = "transparent";
								tomTheme.chart.stroke = "transparent";
								/* get the html element (dom) where we want the chart to be drawn on */
								var chartDom = document.getElementById("rightECG");
								/* create the chart on the dom */
								ECGchart = new Chart(chartDom);
								ECGchart.setTheme(tomTheme);
								/* add the x-axis */
								ECGchart.addAxis("x", {type: "Invisible", majorLabels: false,
									minorTicks: false,
									minorLabels: false,
									microTicks: false});		
								/* add the y-axis */
								ECGchart.addAxis("y", {type: "Invisible", vertical: true,
									majorLabels: false,
									minorTicks: false,
									minorLabels: false,
									microTicks: false});
								/* optional add the grid */
								ECGchart.addPlot("grid", { type: Grid,
									hMajorLines: false,
									hMinorLines: false, 
									vMajorLines: false,
									vMinorLines: false,
									majorHLine: { color: "green", width: 0.2 },
									majorVLine: { color: "red", width: 0.2 } });
							   ECGchart.addPlot("time", { type: plot2dIndicator,
				        			vertical: true,
				        			lineStroke: { color: "#00ccff"},
				        			labels: null,
				        			stroke: null,
				        			outline: null,
				        			fill: null,
				        			offset: { y: -7, x: -10 },
				        			values: 0.0});
								ecgIndicator = ECGchart.getPlot("time");
	
								/* get the html element (dom) where we want the chart to be drawn on */
								var chartDom = document.getElementById("rightLVP");
								/* create the chart on the dom */
								LVPchart = new Chart(chartDom);
								LVPchart.setTheme(tomTheme);
								/* add the x-axis */
								LVPchart.addAxis("x", {type: "Invisible",
									majorLabels: false,
									minorTicks: false,
									minorLabels: false,
									microTicks: false});
								/* add the y-axis */
								LVPchart.addAxis("y", {
									vertical: true,
									min: -40,
									max: 160,
									minorTicks: false,
									majorTickStep: 40,
									titleFont: "normal normal normal 11pt Helvetica",
									title:"(mmHg)",
									titleFontColor:[120, 120, 120]
        						});
								/* optional add the grid */
								LVPchart.addPlot("grid", { type: Grid,
									hMajorLines: false,
									hMinorLines: false, 
									vMajorLines: false,
									vMinorLines: false,
									majorHLine: { color: "green", width: 0.2 },
									majorVLine: { color: "red", width: 0.2 } });
								LVPchart.addPlot("time", { type: plot2dIndicator,
				        			vertical: true,
				        			lineStroke: { color: "#00ccff"},
				        			labels: null,
				        			stroke: null,
				        			outline: null,
				        			fill: null,
				        			offset: { y: -7, x: -10 },
				        			values: 0.0});
								lvpIndicator = LVPchart.getPlot("time");
								document.getElementById('rightInformation').className = 'closed';
							});
					});
			});
		});
				
		function resetAllModelsView() {
			for (var k in modelToSceneArray) {
        		if (modelToSceneArray.hasOwnProperty(k)) {
           			modelToSceneArray[k].resetView();
        		}
    		}
		}
		
		function meshReady(oldCam) {
			return function(mygeometry) {
				if (mygeometry.groupName && mygeometry.groupName.includes("Post")) {
					mygeometry.setVisibility(!halfHeartFlag);
				}
				shareCameraSettings(oldCam);
			}
		}
		
		function loadModel(model_name, rateScaling) {
			metaURL = modelURLsArray[model_name][0];
			viewURL = modelURLsArray[model_name][1];
			var scene = zincRenderer.getSceneByName(model_name);
			if (scene == undefined) {
				scene = zincRenderer.createScene(model_name);
				scene.setDuration(scene.getDuration() / rateScaling);
				scene.loadViewURL(viewURL);
				scene.loadMetadataURL(metaURL, meshReady(previousCamera));
				zincRenderer.setCurrentScene(scene);
				modelToSceneArray[model_name] = scene;
			} else {
				zincRenderer.setCurrentScene(scene);
				shareCameraSettings(previousCamera);
				showHalf();
			}
		}

		function resetView()	{
			zincRenderer.viewAll()
		}
		
		function heartFailureClicked() {
			showIcons("fibrillation_icon", "attack_icon", "failure_selected_icon");
			document.getElementById("home_icon").className = "open";
			document.getElementById("home_selected_icon").className = "closed";
			leftPanelTrigger('leftHeartFailure');
			previousCamera = undefined;
			heartFailureStagePressed('NoFailure', 'NoFailure', 'leftHeartFailure');
		}
		
		var heartFailureStagePressed = function(StageName, pressedElement, descriptionId){
			loadModel(StageName, 1.0);
			previousCamera = zincRenderer.getCurrentScene().camera;
			showECGAndLVP(StageName, 0.0);
			document.getElementById('leftHeartFailure').classList.remove('open');
			document.getElementById('leftHeartFailure').classList.add('closed');
			document.getElementById('leftCompensatedFailure').classList.remove('open');
			document.getElementById('leftCompensatedFailure').classList.add('closed');
			document.getElementById('leftDecompensatedFailure').classList.remove('open');
			document.getElementById('leftDecompensatedFailure').classList.add('closed');
			document.getElementById(descriptionId).classList.remove('closed');
			document.getElementById(descriptionId).classList.add('open');
		}
		
		function updateSlider(newValue)	{
			zincRenderer.setPlayRate(newValue);
		}
		
		var showLVPInternal = function(chartName) {
			if (chartName != currentLVPName) {
				var currentLVP = LVPs[chartName];
				maxLVPTime = currentLVP[currentLVP.length - 1]['x'];
				minLVPTime = currentLVP[0]['x'];
				LVPchart.removeSeries(currentLVPName);
				currentLVPName = chartName;
				LVPchart.addSeries(chartName, currentLVP, { stroke: {color: "lime", width: 2}});
				LVPchart.render();
				LVPchart.resize('100%','100%');
			}
		}
		
		var onLVPLoaded = function(xmlhttp, chartName) {
			return function() {
				if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
					var viewData = JSON.parse(xmlhttp.responseText);
					LVPs[chartName] = viewData;
					showLVPInternal(chartName);
				}
			};
		}
		
		var showECGInternal = function(chartName) {
			if (chartName != currentECGName) {
				var currentECG = ECGs[chartName];
				maxECGTime = currentECG[currentECG.length - 1]['x'];
				minECGTime = currentECG[0]['x'];
				ECGchart.removeSeries(currentECGName);
				currentECGName = chartName;
				ECGchart.addSeries(chartName, currentECG, { stroke: {color: "orange", width: 2}});
				ECGchart.render();
				ECGchart.resize('100%','100%');
			}
		}
		
		var onECGLoaded = function(xmlhttp, chartName) {
			return function() {
				if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
					var viewData = JSON.parse(xmlhttp.responseText);
					ECGs[chartName] = viewData;
					showECGInternal(chartName);
				}
			};
		}
		
		function showECGAndLVP(chartName, timeOffset) {
			timeLineOffset = timeOffset;
			if (ECGs[chartName]) {
				showECGInternal(chartName);
			} else {
				var xmlhttp = new XMLHttpRequest();	
				xmlhttp.onreadystatechange = onECGLoaded(xmlhttp, chartName);
				requestURL = ECGurls[chartName];
				xmlhttp.open("GET", requestURL, true);
				xmlhttp.send();
			}
			
			if (LVPs[chartName]) {
				showLVPInternal(chartName);
			} else {
				var xmlhttp = new XMLHttpRequest();	
				xmlhttp.onreadystatechange = onLVPLoaded(xmlhttp, chartName);
				requestURL = LVPurls[chartName];
				xmlhttp.open("GET", requestURL, true);
				xmlhttp.send();
			}
			if (ECGTexts[chartName])
				document.getElementById('ECGDescription').innerHTML = ECGTexts[chartName];
			if (LVPTexts[chartName])
				document.getElementById('LVPDescription').innerHTML = LVPTexts[chartName];
		}
				
	</script>
	
	
	</body>
</html>
